<h1 class="title"><%= link_to 'â¬… ', request.referer %><%= @transaction.name %></h1>
<h2 class="title is-6"><span class="has-text-grey">Trace ID:</span> <%= @transaction.uuid %></h2>
<h2 class="title is-6"><span class="has-text-grey">Timestamp:</span> <%= @transaction.timestamp %></h2>
<h2 class="title is-6"><span class="has-text-grey">Duration:</span> <%= @transaction.duration.round(2) %> ms</h2>
<h2 class="title is-6"><span class="has-text-grey">Metadata:</span> <%= @transaction.metadata %></h2>

<h2 class="title is-4 mt-6">Spans</h2>

<% min_start_time = @transaction.spans.minimum(:timestamp) %>
<% max_end_time = @transaction.spans.maximum(:end_time) %>
<% total_duration = max_end_time - min_start_time %>

<style>
    .span-details {
        position: absolute;
        right: 0px;
        display: flex;
        align-items: center;
        height: 24px;
        max-width: 100%;
    }

    .span-bar {
        position: relative;
        border-radius: 5px;
    }
</style>

<div class="is-fullwidth">
  <% @transaction.spans.each do |span| %>
    <% left_percent = ((span.timestamp - min_start_time).to_f / total_duration * 100) %>
    <% width_percent = [((span.end_time - span.timestamp).to_f / total_duration * 100), 0.1].max %>
    <% right_percent = (100 - left_percent - width_percent) %>

    <div style="width: 100%; height: 4em;">
      <div style="left: 0; width: 100%">
          <div class="py-3" style="display: block;  position: relative;">
            <div class="span-bar has-background-primary-15" style="left: <%= left_percent %>%; width: <%= width_percent %>%; height: 24px; border-radius: 5px;"></div>
            <span style="min-width: <%= width_percent + right_percent %>%;" class="span-details mt-1 mb-2">
                <span class="has-text-grey-lighter" style="text-overflow: ellipsis; white-space: nowrap; overflow: hidden;"><%= span.name %></span>
                <span class="has-text-grey pl-2" style="white-space: nowrap;"><%= span.duration.round(2) %> ms</span>
                <br/><span><%= span.summary %></span>
            </span>
          </div>
      </div>
    </div>
  <% end %>
</div>
