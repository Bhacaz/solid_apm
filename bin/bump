#!/usr/bin/env ruby
# frozen_string_literal: true

SEM = %w[major minor patch].freeze

# raise if git not clean
raise 'Git is not clean' unless system('git', 'diff', '--quiet')

# raise if not on default branch
raise 'Not on the default branch' unless `git rev-parse --abbrev-ref HEAD`.strip == 'main' || `git rev-parse --abbrev-ref HEAD`.strip == 'master'

sem = ARGV[0]

if sem.nil? || !SEM.include?(sem)
  puts "Please provide a valid semver: #{SEM.join(', ')}"
  exit 1
end

version_file_path = Dir.glob('lib/*/version.rb').first
raise 'Version file not found in lib/*/version.rb' if version_file_path.nil?

current_version_file_content = File.read(version_file_path)
current_version_file_content =~ /VERSION = \W(\d+\.\d+\.\d+)\W/
current_version = Regexp.last_match(1)

major, minor, patch = current_version.split('.').map(&:to_i)

case sem
when 'major'
  major += 1
  minor = 0
  patch = 0
when 'minor'
  minor += 1
  patch = 0
when 'patch'
  patch += 1
end

new_version = "#{major}.#{minor}.#{patch}"

puts "Bumped version from #{current_version} to #{new_version}"
# Ask for confirmation
puts "Are you sure you want to bump the version to #{new_version}? (yes/no)"
confirmation = STDIN.gets.chomp.strip.downcase

unless confirmation == 'yes'
  puts 'Version bump cancelled.'
  exit 0
end

File.write(version_file_path, current_version_file_content.gsub(current_version, new_version))

begin
  system('bundle', 'install')

  system('git', 'add', '.')
  system('git', 'commit', '-m', "Bump to v#{new_version}")
  system('git', 'tag', '-am', "v#{new_version}", "v#{new_version}")

  system('git', 'push')
  system('git', 'push', '--tags')
rescue StandardError => e
  puts "Failed: #{e.message}"
  exit 1
end
